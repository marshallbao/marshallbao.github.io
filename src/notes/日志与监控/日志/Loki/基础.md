# 架构

### 架构和核心组件



组件

| Component                                                    | *individual* | `all` | `read` | `write` | `backend` |
| :----------------------------------------------------------- | :----------- | :---- | :----- | :------ | :-------- |
| [Distributor](https://grafana.com/docs/loki/latest/get-started/components/#distributor) | x            | x     |        | x       |           |
| [Ingester](https://grafana.com/docs/loki/latest/get-started/components/#ingester) | x            | x     |        | x       |           |
| [Query Frontend](https://grafana.com/docs/loki/latest/get-started/components/#query-frontend) | x            | x     | x      |         |           |
| [Query Scheduler](https://grafana.com/docs/loki/latest/get-started/components/#query-scheduler) | x            | x     |        |         | x         |
| [Querier](https://grafana.com/docs/loki/latest/get-started/components/#querier) | x            | x     | x      |         |           |
| [Index Gateway](https://grafana.com/docs/loki/latest/get-started/components/#index-gateway) | x            |       |        |         | x         |
| [Compactor](https://grafana.com/docs/loki/latest/get-started/components/#compactor) | x            | x     |        |         | x         |
| [Ruler](https://grafana.com/docs/loki/latest/get-started/components/#ruler) | x            | x     |        |         | x         |
| [Pattern ingester](https://grafana.com/docs/loki/latest/get-started/components/#pattern-ingester) | x            | x     |        | x       |           |
| [Bloom Planner (Experimental)](https://grafana.com/docs/loki/latest/get-started/components/#bloom-planner) | x            |       |        |         | x         |
| [Bloom Builder (Experimental)](https://grafana.com/docs/loki/latest/get-started/components/#bloom-builder) | x            |       |        |         | x         |
| [Bloom Gateway (Experimental)](https://grafana.com/docs/loki/latest/get-started/components/#bloom-gateway) | x            |       |        |         | x         |



### 部署模式

整体模式

最简单的运行模式是单体部署模式。您可以通过设置`-target=all`命令行参数来启用单体模式。此模式会将 Loki 的所有微服务组件作为一个单独的二进制文件或 Docker 镜像，在单个进程中运行。

可以选单节点也可以多副本

helm 核心 value

```
minio:
  enabled: true
deploymentMode: SingleBinary
singleBinary:
  replicas: 1
```

简单可扩展模式

Loki 简单易用的可扩展部署模式将执行路径拆分为读取、写入和后端目标

helm 核心 value

```
deploymentMode: SimpleScalable
backend:
  replicas: 2
read:
  replicas: 2
write:
  replicas: 3 # To ensure data durability with replication
# Enable minio for storage
minio:
  enabled: true
gateway:
  service:
    type: LoadBalancer
```

微服务模式

微服务部署模式将 Loki 的各个组件作为独立的进程运行。微服务部署也称为分布式部署。每个进程在调用时都会指定其进程 ID。

helm 核心 value

```
deploymentMode: Distributed
ingester:
  replicas: 3 
  zoneAwareReplication:
     enabled: false
querier:
  replicas: 3 # Improve query performance via parallelism
  maxUnavailable: 2
queryFrontend:
  replicas: 2
  maxUnavailable: 1
queryScheduler:
  replicas: 2
distributor:
  replicas: 3 
  maxUnavailable: 2
compactor:
  replicas: 1
indexGateway:
  replicas: 2
  maxUnavailable: 1
gateway:
   service:
     type: LoadBalancer
minio:
  enabled: true
```



除了 Loki 核心组件还有其他组件也需要安装

```
loki-canary：作用是主动验证和审计 Loki 的功能和性能
loki-chunks-cache
loki-results-cache： 这俩都是缓存作用，实际上就是 memcached 服务
loki-gateway：是 nginx 服务，用于多实例的负载均衡
```



### 参考 

https://grafana.com/docs/loki/latest/fundamentals/architecture/components/

https://grafana.com/docs/loki/latest/get-started/deployment-modes/

https://grafana.com/docs/loki/latest/setup/install/helm/install-scalable/

https://grafana.com/docs/loki/latest/setup/install/helm/install-monolithic/