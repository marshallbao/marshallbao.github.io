# Nginx 代理

4 层代理

```
cat  > tableau.conf << EOF
stream {
  upstream tableau {
    hash \$remote_addr consistent;
    server 10.120.14.113:80 weight=5 max_fails=3 fail_timeout=30s;
  }
  server {
    listen 81 so_keepalive=on;
    proxy_connect_timeout 10s;
    proxy_timeout 300s;
    proxy_pass tableau;
  }
}
EOF
```

7 层代理

```shell
cat  > tableau7.conf << EOF
server{
  listen 81;
  server_name 127.0.0.1;

  location / {
    proxy_pass  http://10.120.14.113:80;
    proxy_set_header Host \$proxy_host;
    proxy_set_header X-Real-IP \$remote_addr;
    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
  }
}
EOF
```

代理 gRPC                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    

```
    upstream grpc_backend {
      server node:9090;
    }
    server {
      listen 80 http2;
      server_name grpc.example.com;

      location / {
        grpc_pass grpc://grpc_backend;
      }

    }
```

代理 socket

客户端发起请求携带请求头

```
Upgrade: websocket
Connection: Upgrade
```

nginx 代理配置

```
# 完整配置如下
server {
    listen 443 ssl;
    server_name teable.bianjie.ai;

    location /socket {
        proxy_pass http://192.168.0.188:3000;
        proxy_set_header Host $host;

        # 以下 3 项是代理 socket 需要加的配置
        proxy_http_version 1.1;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Upgrade $http_upgrade;

        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# 解释
1️⃣ proxy_http_version 1.1
WebSocket 要求 HTTP/1.1，因为 HTTP/1.0 不支持 Upgrade 机制。

2️⃣ proxy_set_header Upgrade $http_upgrade
这个 header 是 WebSocket 握手时关键字段，用来告诉后端要“升级协议”，从 HTTP 切换为 WebSocket。

3️⃣ proxy_set_header Connection "upgrade"
这个字段告诉代理链路，当前请求需要“保持连接并升级”，必须是 固定的小写 "upgrade"，对应前面的 Upgrade 头。


# 如果你在同一个 location 里代理的既有普通 HTTP，也有 WebSocket，可以这样动态判断：
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

server {
    ...
    location /ws/ {
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        ...
    }
}


```

