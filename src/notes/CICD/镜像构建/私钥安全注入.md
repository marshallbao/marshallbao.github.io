## Docker 镜像构建过程中的私钥安全注入

### 目前的方案

以 golang 项目为例子的 dockerfile

```
FROM repo.bianjie.ai/golang/golang:1.23.8-alpine3.20 AS builder

ENV PACKAGES="make git libc-dev bash"
ARG GITUSER
ARG GITPASS
ARG GOPRIVATE=gitlab.bianjie.ai
ARG GOINSECURE=gitlab.bianjie.ai
ARG GOPROXY=https://goproxy.cn,direct
ARG APKPROXY=mirrors.ustc.edu.cn
WORKDIR $GOPATH/src
COPY . .
# Install minimum necessary dependencies, build binary
RUN sed -i "s/dl-cdn.alpinelinux.org/${APKPROXY}/g" /etc/apk/repositories && \
    apk add --no-cache $PACKAGES && \
    git config --global url."https://${GITUSER}:${GITPASS}@gitlab.bianjie.ai".insteadOf "https://gitlab.bianjie.ai" && \
    git config --global http.sslVerify false && \
make install
 
FROM repo.bianjie.ai/alpine/alpine:3.20
COPY --from=builder /go/bin/{BINARY_NAME} /usr/local/bin/{BINARY_NAME} && \
    chown -R appuser:appgroup /usr/local/bin/{BINARY_NAME}
 
USER appuser
 
CMD ["sh","-c","order-server start"]
```



构建命令

```
docker build --no-cache  --build-arg 'GITUSER=Jenkins' --build-arg 'GITPASS=glpat-xxx'  -t repo.bianjie.ai/group/name:tag .
```



### 目前方案的问题

1. 通过 --build-arg 传入gitlab 私钥，会导致私钥通过 docker history repo.bianjie.ai/group/name:tag 进行泄露，存在安全问题；
2. 通过 git config --global url."https://${GITUSER}:${GITPASS}@gitlab.bianjie.ai".insteadOf "https://gitlab.bianjie.ai" 的方式配置 git，只适用于 golang，如果是 nodejs 项目会有问题；
3. 只有依赖存在于 gitlab 私有仓库的项目，包括 golang/nodejs，才有这个问题；

### 改进方案&&解决问题

dockerfile

```
FROM repo.bianjie.ai/golang/golang:1.23.8-alpine3.20 AS builder

ENV PACKAGES="make git libc-dev bash"
ARG GOPRIVATE=gitlab.bianjie.ai
ARG GOINSECURE=gitlab.bianjie.ai
ARG GOPROXY=https://goproxy.cn,direct
ARG APKPROXY=mirrors.ustc.edu.cn
WORKDIR $GOPATH/src
COPY . .
# Install minimum necessary dependencies, build binary

RUN --mount=type=secret,id=gituser \
    --mount=type=secret,id=gitpass \
    set -e; \
    GITUSER=$(cat /run/secrets/gituser) && \
    GITPASS=$(cat /run/secrets/gitpass) && \
    echo "machine gitlab.blockbeat.hk" > /root/.netrc && \
    echo "login ${GITUSER}" >> /root/.netrc && \
    echo "password ${GITPASS}" >> /root/.netrc && \
    chmod 600 /root/.netrc && \
    sed -i "s/dl-cdn.alpinelinux.org/${APKPROXY}/g" /etc/apk/repositories && \
    apk add --no-cache $PACKAGES && \
    git config --global http.sslVerify false && \
    make all && rm -rf /root/.netrc


# 如果是多阶段构建，可以不需要删除 /root/.netrc 文件；
# 如果是就一次构建，必须要删除  /root/.netrc 文件；
```

构建命令

```
export GITUSER=jenkins export GITPASS=glpat-xxx docker build --no-cache --secret id=gituser,env=GITUSER --secret id=gitpass,env=GITPASS -t repo.bianjie.ai/group/name:tag .
```



### 后续

1. 新建 jenkins job 并根据需求更新 jenkinsfile
2. 各个项目的 dockerfile 需要更新