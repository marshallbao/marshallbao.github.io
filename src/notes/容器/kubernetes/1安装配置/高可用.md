# 高可用

### 常用工具 kube-vip

### 原理



### 模式

BGP



ARP（简单，推荐）



### 示例

k3s + kube-vip

```
# 禁用 kube-vip 的 lb 控制器，只作用于 master 高可用
# kube-vip manifest daemonset 没有添加 --services 参数

# 生成 ds 文件
# INTERFACE 网卡名字; VIP 是虚拟的 ip;要和主机的网络打通；要么新建一个子网并打通网络；要么在同一个子网用空闲的 IP;

export VIP=192.168.0.250
export INTERFACE=ens160
KVVERSION=v1.0.3
alias kube-vip="docker run --network host --rm repo.bianjie.ai/kube-vip/kube-vip:v1.0.3"

kube-vip manifest daemonset \
    --interface $INTERFACE \
    --address $VIP \
    --inCluster \
    --taint \
    --controlplane \
    --arp \
    --leaderElection
# 下载 rbac 文件 ；组成一个 yaml 文件 --> kube-vip.yaml

# 创建目录，上传 kube-vip.yaml 文件
mkdir  -p /var/lib/rancher/k3s/server/manifests

# master1 安装

export INSTALL_K3S_MIRROR=cn
export INSTALL_K3S_VERSION=v1.32.9+k3s1
export K3S_TOKEN=prodk3s1

curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | sh -s - server \
    --cluster-init \
    --tls-san=192.168.0.250

# master2/3
export INSTALL_K3S_MIRROR=cn
export INSTALL_K3S_VERSION=v1.32.9+k3s1
export K3S_TOKEN=prodk3s1

curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | sh -s - server \
    --server https://192.168.0.250:6443 \
    --tls-san=192.168.0.250

# kubeconfig 文件；此时可以修改  kubeconfig 文件中的 server 地址为 VIP；
cat  /etc/rancher/k3s/k3s.yaml

# 验证
# 在所有master 上执行 ip a 能够看到 vip;如果
ip a

# 关于 LB 控制器
要么禁用 k3s 的 servicelb,要么禁用 kube-vip 的 --services 参数；这两个会有冲突
```





另外，关于 k3s 和 kubeadm 集群，对于 kube-vip 静态 Pod 和 DaemonSet  模式的选择

k3s 使用DaemonSet 模式；kubeadm 使用静态 Pod 模式

为什么？

在标准的 Kubernetes（kubeadm）中，你必须先有 VIP，第二个 Master 节点才能加入集群。这就产生了一个矛盾：如果没有集群，就没法运行 DaemonSet；但没有 DaemonSet 提供的 VIP，你就没法初始化高可用集群。因此，kubeadm 必须使用 **Static Pod**。

但 K3s 的逻辑不同：

1. **首节点自引导：** K3s 允许你先启动第一个 Server 节点。
2. **Auto-Deploy：** 启动后，K3s 会扫描 `/var/lib/rancher/k3s/server/manifests/` 文件夹。
3. **部署 VIP：** 你可以将 kube-vip 的 DaemonSet 清单放在这个文件夹里，K3s 会自动安装它并产生 VIP。
4. **后续节点加入：** 第二、三个 Master 节点使用这个 VIP 加入集群。



### 参考

https://kube-vip.io/docs/usage/k3s/

https://kube-vip.io/docs/installation/daemonset/