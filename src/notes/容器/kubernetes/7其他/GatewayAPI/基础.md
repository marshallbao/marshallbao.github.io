# 基础

Gateway API 就是一组 CRD 资源，用来代替之前的 ingress，真正起作用的是 gatewayclass-controller，这是一个真正的服务，目前有很多 gatewayclass-controller，包括原生的 Envoy Gateway  ，第三方的 NGINX Gateway Fabric 、Kong Gateway 、Apache APISIX 等

Gateway API 具有四种稳定的 API 类别：

- **GatewayClass：** 定义一组具有配置相同的网关，由实现该类的控制器管理。
- **Gateway：** 定义流量处理基础设施（例如云负载均衡器）的一个实例。
- **HTTPRoute：** 定义特定于 HTTP 的规则，用于将流量从 Gateway 监听器映射到后端网络端点的某种呈现。 这些端点通常表示为 [Service](https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/)。

- **GRPCRoute：** 定义特定于 gRPC 的规则，用于将流量从 Gateway 监听器映射到后端网络端点的某种呈现。 这些端点通常表示为 [Service](https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/)。



### 部署

你可以先单独部署 gateway api 的 CRD 资源，也可以直接安装控制器，控制器的 helm 里包括 gateway api 的 CRD 资源；

```
# 安装 crd (可选)
kubectl apply --server-side -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.4.1/standard-install.yaml


#  安装 envoy-gateway
helm install eg oci://docker.io/envoyproxy/gateway-helm --version v1.6.1 -n envoy-gateway-system --create-namespace

# 卸载 envoy-gateway
helm uninstall eg -n envoy-gateway-system
```



### GatewayClass  控制器

Envoy Gateway 

NGINX Gateway Fabric 

Kong Gateway 

Apache APISIX 

使用

```
# 创建 GatewayClass 集群级别的资源
apiVersion: gateway.networking.k8s.io/v1
kind: GatewayClass
metadata:
  name: eg
spec:
  controllerName: gateway.envoyproxy.io/gatewayclass-controller
---
# 创建 Gateway ns 级别的资源
# 注意创建出 gateway 时，相当于一个代理 pod,以及一个 lb 类型的 svc 来接受流量
# 最好在云上使用，本地机房没有 lb 控制器，基本没法用；
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: eg
spec:
  gatewayClassName: eg
  listeners:
    - name: http
      protocol: HTTP
      port: 80
      allowedRoutes:
        namespaces:
          from: All
---
# 创建 httproute
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: nginx-route
  namespace: test
  labels:
    app: nginx
spec:
  parentRefs:
    - name: eg
      namespace: default
  hostnames:
    - "nginx-test.example.com"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: nginx-service
          port: 80
---
# 跨命名空间访问 service
# 目标业务层 (Namespace: nb),使 na ns 下 httproute 可以调用其他 ns 的 service
apiVersion: gateway.networking.k8s.io/v1beta1
kind: ReferenceGrant
metadata:
  name: service-to-na
  namespace: nb
spec:
  from:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      namespace: na # 授权来自哪个 NS 的路由
  to:
    - group: ""
      kind: Service # 允许它们引用本命名空间的 Service
```



### 参考

https://gateway-api.sigs.k8s.io/guides/getting-started/

https://gateway.envoyproxy.io/docs/tasks/quickstart/