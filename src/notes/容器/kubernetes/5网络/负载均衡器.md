# 负载均衡器

### 常用解决方案

kube-vip 和 MetalLB 的区别

| **特性**                 | **kube-vip**                       | **MetalLB**                                   |
| ------------------------ | ---------------------------------- | --------------------------------------------- |
| **主要定位**             | **控制平面 HA** + 服务负载均衡     | **服务负载均衡 (Service Type: LoadBalancer)** |
| **控制平面高可用 (VIP)** | 原生支持（为 API Server 提供 VIP） | 不支持（通常需配合 Keepalived/kube-vip）      |
| **工作模式**             | ARP (L2), BGP, mDNS                | ARP/NDP (L2), BGP                             |
| **部署形式**             | 静态 Pod、DaemonSet 或二进制       | 控制器 (Controller) + Speaker (DaemonSet)     |
| **成熟度**               | 在边缘计算和轻量化场景极具优势     | 在裸金属集群 Service 负载均衡领域最成熟       |



### MetalLB



```
# 修改 kube-proxy 配置
kubectl edit configmap -n kube-system kube-proxy
strictARP: true

# 安装
kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.15.3/config/manifests/metallb-native.yaml

# 使用
# 创建 IPAddressPool
root@master1:~/metallb# cat ip-pool.yaml
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: ip-pool
  namespace: metallb-system
spec:
  addresses:
    - 192.168.0.240-192.168.0.250 #分配给LB的IP池

# 创建一个广播声明，关联上面的 IP 池对象:
root@master1:~/metallb# cat advertise.yaml
apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: l2adver
  namespace: metallb-system
spec:
  ipAddressPools:
    - ip-pool

```



### kube-vip

```
# 生成 ds yaml
# arp 模式
# 只作用于 LB 控制器
export INTERFACE=ens160
alias kube-vip="docker run --network host --rm repo.bianjie.ai/kube-vip/kube-vip:v1.0.3"

kube-vip manifest daemonset \
    --interface $INTERFACE \
    --inCluster \
    --taint \
    --arp \
    --services \
    --leaderElection
   
# 下载 rbac.yaml；组合成 kube-vip 一个 yaml；
kubectl apply -f kube-vip.yaml

# 部署 kube-vip-cloud-controller
kubectl apply -f https://raw.githubusercontent.com/kube-vip/kube-vip-cloud-provider/main/manifest/kube-vip-cloud-controller.yaml

# 配置 ip 范围，两种方式
kubectl create configmap -n kube-system kubevip --from-literal cidr-global=192.168.0.220/29

kubectl create configmap -n kube-system kubevip --from-literal range-global=192.168.1.220-192.168.1.230

# 使用

```



### 参考

https://metallb.io/installation/

https://kube-vip.io/docs/installation/daemonset/

https://kube-vip.io/docs/usage/cloud-provider/#install-the-kube-vip-cloud-provider