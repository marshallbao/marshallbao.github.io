# CDN

### CDN 概念

CDN（内容分发网络）是由一组位于全球不同地理位置的服务器构成的网络，用于提供高效分发静态和动态内

容。它通过将内容缓存到离用户更近的位置，减少了响应时间和带宽消耗，并提供更好的用户体验

### CDN 接入

前端服务接入 CDN，可以缓存 js/image/css/html 等静态资源

后端服务接入 CDN 可以改善网络连接的性能和可用性，而不是直接提供缓存服务

PS：请求后端接口，接口返回的数据，CDN 是无法进行缓存的；

### CDN 原理

- 客户端向 CDN 发送请求。
- CDN 根据内容的缓存策略检查是否存在缓存副本。
- 如果缓存存在且有效，则返回缓存的副本给客户端。
- 如果缓存不存在或已过期，则执行回源操作，从源服务器获取最新内容并缓存。
- CDN 返回新获取的内容给客户端，并保存在缓存中。

### CDN 优势

- 提升网站性能：通过使用离用户更近的服务器，减少响应时间和延迟。
- 减轻源服务器负载：缓存和分发内容减少了直接访问源服务器的需求。
- 提高可用性和容错能力：多个边缘节点可以在某个节点故障时提供备份服务。
- 支持大流量和突发流量：CDN 可以在处理大量并发请求时提供更好的扩展性。

### CDN 最佳实践

- 缓存策略优化：根据内容类型、缓存头设置和用户行为进行适当的缓存配置。
- 高可用性设计：使用多个 CDN 边缘节点和合理的负载均衡策略，确保高可用性和容错能力。
- 安全性保护：使用 HTTPS 加密进行内容传输，并实施有效的安全措施，如 DDoS 防护和访问控制。
- 监测和分析：使用监测工具和日志分析来了解 CDN 性能和用户行为，以及进行故障排除和性能优化。
- 定期测试和验证：周期性地测试 CDN 的性能、可用性和回源机制，确保其正常运行和与源服务器同步。

### 参考

https://www.cnblogs.com/rayray/p/3553696.html

#### CDN 工作流程-我的理解

首先要进行配置，将 test.com cname 到 cdn 域名；

当我访问 test.com 时，会携带我的出口 ip，我会先访问到 cdn 系统，cdn 智能系统根据我的 ip，返回给我一个近的 ip，然后我再去请求

这个 ip 节点（也就是CDN边缘节点）来看看是否有缓存数据，如果有则直接返回，没有则进行回源请求；

纠错！！！

CDN 并不是在“连接”建立后才去找节点，而是在 **DNS 解析阶段**，通过识别你的来源 IP，直接把离你最近的那个服务器的 IP 地址“喂”给你的浏览器。

#### 修正后的标准流程图解

1. **DNS 解析阶段（关键环节）：**
   - 你输入 `test.com`。
   - DNS 发现有 CNAME 指向了 CDN 厂商的域名。
   - CDN 的 **智能调度 DNS** 收到请求，分析你的地理位置和运营商，决定把离你最近、负载最低的 **边缘节点 IP** 给你。
2. **建立连接：**
   - 你的浏览器拿到这个 IP 后，直接向这个 **边缘节点** 发起请求。
3. **缓存命中与回源：**
   - **命中：** 边缘节点有缓存，直接给你数据（毫秒级响应）。
   - **未命中：** 边缘节点化身“客户端”，去源站（你的服务器）拉取数据，缓存下来并返回给你。

回源请求是边缘节点来进行的，对于大型的 CDN 可能会先去区域中心节点来访问查看是否有缓存，如果没有再到源站去请求；请求到后会放在本地且同时返回给你；





#### 其他

在 CDN 领域，精准调度主要分为 **DNS 调度**（最常用）和 **HTTP 302 调度**（最精准）

| **特性**     | **DNS 调度 (路牌模式)** | **HTTP 302 调度 (交警模式)**       |
| ------------ | ----------------------- | ---------------------------------- |
| **判断依据** | 用户的 Local DNS IP     | 用户的 **真实出口 IP**             |
| **精准度**   | 中（受 DNS 设置影响）   | **极高**                           |
| **延迟**     | 低（解析后直接连接）    | 高（多了一次跳转请求）             |
| **适用场景** | 网页、图片、小文件      | **视频、App 安装包、私有链路优化** |
| **成本**     | 低                      | 高（调度中心也得抗流量）           |

HTTP 302 调度

**工作原理：** 1.  你访问 `test.com/movie.mp4`，DNS 解析给你的是一个 **中控调度中心** 的 IP。 2.  你的浏览器连接到这个调度中心。 3.  调度中心直接看到了 **你的真实出口 IP**（不是 DNS 的 IP），然后查表发现你在“朝阳区某街道”。 4.  调度中心不给你数据，而是返回一个 **HTTP 302（重定向）** 状态码，告诉浏览器：“去访问 `http://node-chaoyang.test.com/movie.mp4` 吧”。 5.  你的浏览器自动跳转到那个最精确的地址。



移动端 App 流行使用 **HTTPDNS**，App 不再通过系统的 DNS 模块查询，而是直接发一个 HTTP 请求给 CDN 厂商：“喂，我是这个 IP，请告诉我最合适的节点 IP”。这样既绕过了 DNS 污染，又实现了像 302 一样的精准度，还没那么大的延迟。